# 03. 创建飞书应用

本文档介绍如何在飞书开放平台创建应用并获取必要的配置信息。

## 前置要求

- 飞书企业账号（个人账号也可以，但需要创建团队）
- 管理员权限（用于创建和发布应用）

## 步骤 1：访问飞书开放平台

打开浏览器访问：[https://open.feishu.cn/app](https://open.feishu.cn/app)

- 如果未登录，使用飞书账号登录
- 选择要创建应用的企业/团队

## 步骤 2：创建企业自建应用

1. 点击页面左上角的「**创建应用**」按钮

2. 选择「**创建企业自建应用**」

3. 填写应用信息：
   - **应用名称**：例如「AI 助手」「Clawdbot」
   - **应用描述**：简要说明应用用途
   - **应用图标**：上传一个图标（可选）

4. 点击「**创建**」

## 步骤 3：获取 App ID 和 App Secret

创建成功后，你会进入应用管理页面。

1. 在左侧导航栏找到「**凭证与基础信息**」

2. 记录以下信息（**非常重要**）：
   - **App ID**：格式类似 `cli_xxxxxxxx`
   - **App Secret**：点击「查看」后复制

## 步骤 4：添加机器人能力

1. 在左侧导航栏找到「**添加应用能力**」

2. 找到「**机器人**」，点击「**添加**」

3. 配置机器人信息：
   - **机器人名称**：显示在飞书中的名称
   - **描述**：机器人的简要说明
   - **头像**：机器人的头像图片（可选）
   - **消息卡片请求网址**：留空（暂不需要）

4. 点击「**保存**」

## 步骤 5：配置权限

在左侧导航栏找到「**权限管理**」，申请以下权限（可以直接搜索）：


- ✅ **获取与发送单聊、群组消息** (`im:message`)
  - 允许机器人发送消息
  
- ✅ **读取用户发给机器人的单聊消息** (`im:message:send_as_bot`)
  - 允许机器人接收消息

- ✅ **接收机器人单聊消息** (`im:message.p2p_msg`)
  - 允许机器人接收单聊事件（常用于长连接/事件订阅）

- ✅ **获取群组信息** (`im:chat`)
  - 允许机器人获取群聊信息

**申请方式：**
1. 在权限列表中找到对应权限
2. 点击「**申请**」
3. 填写申请理由（例如：「用于 AI 助手接收和发送消息」）
4. 等待审批（企业自建应用通常秒批）

## 步骤 6：事件订阅（稍后配置）

事件订阅需要在 Gateway 启动后配置，因此：

1. 现在**不需要**在飞书后台配置事件订阅
2. 继续完成后续步骤（发布应用）
3. 等安装好插件并启动 Gateway 后，再回到飞书后台配置

> 📖 **详细步骤**：完成应用发布后，查看 [05. 启动和配置 Gateway](05-gateway-setup.md) 文档

## 步骤 7：发布应用

1. 在应用管理页面，找到「**版本管理与发布**」

2. 点击「**创建版本**」

3. 填写版本信息：
   - **版本号**：例如 `1.0.0`
   - **更新说明**：简要说明功能

4. 点击「**保存**」

5. 点击「**申请发布**」

6. 选择发布范围：
   - **全员可用**（推荐）
   - 或指定部门/用户

7. 提交审核

   > 💡 企业自建应用通常会自动通过审核

8. 审核通过后，点击「**发布**」

## 验证配置

### 1. 检查应用状态

在应用管理页面，确认：
- ✅ 应用状态：「**已发布**」
- ✅ 机器人状态：「**已启用**」
- ✅ 权限状态：「**已通过**」
- ✅ 事件订阅：「**已配置**」

### 2. 在飞书中查找机器人

1. 打开飞书客户端
2. 搜索你的机器人名称
3. 找到机器人并发送消息：`你好`

### 3. 查看 Gateway 日志

应该能看到：

```
[feishu] 收到消息 chat=oc_xxx from=ou_xxx type=text len=2
```

## 常见问题

### Q: 保存长连接配置时提示「应用未建立长连接」

**A:** 原因和解决方法：
1. **Gateway 未启动** → 先启动 Gateway
2. **App ID/Secret 错误** → 检查配置文件
3. **插件未安装** → 运行 `./install-plugin.sh`
4. **防火墙阻止** → 检查网络连接

### Q: 权限申请一直显示「审批中」

**A:** 
- 企业自建应用通常秒批
- 如果长时间未通过，联系企业管理员
- 或在「权限管理」页面查看审批状态

### Q: 机器人头像和名称如何修改？

**A:** 
1. 进入「**机器人**」配置页面
2. 修改名称、描述或头像
3. 保存后需要重新发布版本

### Q: 如何删除或停用应用？

**A:** 
1. 进入「**版本管理与发布**」
2. 点击「**停用当前版本**」
3. 或在应用列表中删除应用

### Q: 支持 Lark（国际版）吗？

**A:** 支持！配置步骤相同，只需：
- 访问 [https://open.larksuite.com/app](https://open.larksuite.com/app)
- 在插件配置中使用 `Lark.Domain.Lark` 而不是 `Lark.Domain.Feishu`

## 下一步

完成飞书应用配置后，继续：

- [04. 安装飞书插件](04-plugin-installation.md) - 在 Clawdbot 中安装插件
- [05. 启动和配置 Gateway](05-gateway-setup.md) - 启动并测试

## 相关资源

- [飞书开放平台](https://open.feishu.cn)
- [飞书开放平台文档](https://open.feishu.cn/document)
- [长连接接收事件](https://open.feishu.cn/document/server-docs/event-subscription-guide/event-subscription-configure-/subscribe-to-events)
